server {
    server_name localhost 127.0.0.1;
    
    # Serve the static web files
    location / {
        root /home/philg/projects/nepal_chatbot/channels/webchat;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # Optional port 8000 proxy
    location /port8000/ {
        proxy_pass http://localhost:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Special location for Rasa server on port 5005 with WebSocket support
    location ~* ^/socket\.io/ {
        proxy_pass http://localhost:5005;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
    }

    # Handle root socket.io without trailing slash
    location = /socket.io {
        proxy_pass http://localhost:5005/socket.io;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
    }

    # And add the root location for accessible socket.io
    location ~* ^/accessible-socket\.io/ {
        proxy_pass http://localhost:5001;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
    }

    # Handle root accessible-socket.io without trailing slash
    location = /accessible-socket.io {
        proxy_pass http://localhost:5001/socket.io;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
    }

    # Proxy REST API requests to the Rasa server (port 5005)
    location /webhooks/rest/ {
        proxy_pass http://localhost:5005/webhooks/rest/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type";
    }

    # Proxy file uploads to the File Server on port 5001
    location /upload-files {
        proxy_pass http://localhost:5001/upload-files;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 20M;  # Increased to handle larger files
        proxy_read_timeout 300;    # 5 minutes timeout for large uploads
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
    }

    # Proxy file downloads from the File Server
    location /files/ {
        proxy_pass http://localhost:5001/files/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
    }

    # Proxy task status checks
    location /task-status/ {
        proxy_pass http://localhost:5001/task-status/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy Custom Actions Server (Rasa SDK) - port 5055
    location /actions/ {
        proxy_pass http://localhost:5055/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Redirect exact /accessible URL (no trailing slash)
    location = /accessible {
        return 301 /accessible/;
    }

    # Handle root /accessible/ directory with language detection
    location = /accessible/ {
        # Check for URL parameter (?lang=en or ?lang=ne)
        if ($args ~ "lang=en") {
            return 302 /accessible/en/;
        }
        if ($args ~ "lang=ne") {
            return 302 /accessible/ne/;
        }

        # Default based on browser language
        if ($http_accept_language ~* "en") {
            return 302 /accessible/en/;
        }

        # Default to Nepali
        return 302 /accessible/ne/;
    }

    # Handle English version
    location = /accessible/en/ {
        alias /home/philg/projects/nepal_chatbot/channels/accessible/;
        try_files /index_en.html =404;
    }

    # Handle Nepali version
    location = /accessible/ne/ {
        alias /home/philg/projects/nepal_chatbot/channels/accessible/;
        try_files /index.html =404;
    }

    # Static files for accessible interface
    location /accessible/ {
        alias /home/philg/projects/nepal_chatbot/channels/accessible/;
        try_files $uri $uri/ =404;
    }

   # Serve the shared assets and styles
    location /shared/ {
       alias /home/philg/projects/nepal_chatbot/channels/shared/;
       try_files $uri $uri/ =404;
    }

    # Accessible API proxy - handles all API endpoints for the accessible interface
    location /accessible-api/ {
        proxy_pass http://localhost:5001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 25M;
        # Add CORS headers
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;
    }

    # Proxy voice recording uploads from accessible interface
    location /accessible-api/submit-grievance {
        proxy_pass http://localhost:5001/submit-grievance;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 50M;  # Increased for voice recordings
        proxy_read_timeout 300;    # 5 minutes timeout for processing
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        # Add CORS headers
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;
    }

    # Proxy managing the old submit-voice-grievance
    location = /accessible-api/submit-voice-grievance {
      return 307 /accessible-api/submit-grievance;
    }

    # Proxy accessible file uploads
    location /accessible-api/accessible-file-upload {
        proxy_pass http://localhost:5001/accessible-file-upload;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 50M;  # Increased for voice recordings
        proxy_read_timeout 300;    # 5 minutes timeout for processing
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        # Add CORS headers
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;
    }

    # Proxy grievance review requests to the Flask server on port 5001
    location /grievance-review/ {
        proxy_pass http://localhost:5001/grievance-review/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 20M;
    }

    # Global CORS settings
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type" always;

    listen 80;
}
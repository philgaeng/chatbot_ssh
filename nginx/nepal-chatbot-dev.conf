server {
    listen 80;
    listen 443 ssl;
    server_name nepal-gms-chatbot.facets-ai.com 52.221.59.184;

    # SSL configuration
    ssl_certificate     /etc/letsencrypt/live/nepal-gms-chatbot.facets-ai.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/nepal-gms-chatbot.facets-ai.com/privkey.pem;
    
    # Include optimized SSL parameters generated by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Redirect HTTP to HTTPS
    if ($scheme = http) {
        return 301 https://$host$request_uri;
    }

    # Serve the static web files
    location / {
        root /home/ubuntu/nepal_chatbot/test_webchat;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # Optional port 8000 proxy
    location /port8000/ {
        proxy_pass http://localhost:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Special location for Rasa server on port 5005 with WebSocket support
    location ~* ^/socket\.io/ {
        proxy_pass http://localhost:5005;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
    }

    # Handle root socket.io without trailing slash
    location = /socket.io {
        proxy_pass http://localhost:5005/socket.io;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
    }

    # Proxy REST API requests to the Rasa server (port 5005)
    location /webhooks/rest/ {
        proxy_pass http://localhost:5005/webhooks/rest/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type";
    }

    # Proxy file uploads to the File Server on port 5001
    location /upload-files {
        proxy_pass http://localhost:5001/upload-files;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 20M;
    }

    # Proxy Custom Actions Server (Rasa SDK) - port 5055
    location /actions/ {
        proxy_pass http://localhost:5055/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Global CORS settings
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type" always;
}

server {
    server_name chatbot-dev.facets-ai.com 18.141.5.167;

    # Redirect HTTP to HTTPS
    if ($scheme = http) {
        return 301 https://$host$request_uri;
    }

    # Serve the static web files
    location / {
        root /home/ubuntu/nepal_chatbot/channels/webchat;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # Optional port 8000 proxy
    location /port8000/ {
        proxy_pass http://localhost:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Special location for Rasa server on port 5005 with WebSocket support
    location ~* ^/socket\.io/ {
        proxy_pass http://localhost:5005;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
    }

    # Handle root socket.io without trailing slash
    location = /socket.io {
        proxy_pass http://localhost:5005/socket.io;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
    }

    # Proxy REST API requests to the Rasa server (port 5005)
    location /webhooks/rest/ {
        proxy_pass http://localhost:5005/webhooks/rest/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type";
    }

    # Proxy file uploads to the File Server on port 5001
    location /upload-files {
        proxy_pass http://localhost:5001/upload-files;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 20M;
    }

    # Proxy Custom Actions Server (Rasa SDK) - port 5050
    location /actions/ {
        proxy_pass http://localhost:5050/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Serve the accessible interface
    location /accessible/ {
        alias /home/ubuntu/nepal_chatbot/channels/accessible/;
        index index.html;
        try_files $uri $uri/ =404;
    }
    
    # Serve shared resources
    location /shared/ {
        alias /home/ubuntu/nepal_chatbot/channels/shared/;
        try_files $uri $uri/ =404;
    }
    
    # Accessible API proxy - handles all API endpoints for the accessible interface
    location /accessible-api/ {
        proxy_pass http://localhost:5001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 25M;
        # Add CORS headers
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;
    }

    # Global CORS settings
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type" always;

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/chatbot-dev.facets-ai.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chatbot-dev.facets-ai.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = chatbot-dev.facets-ai.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name chatbot-dev.facets-ai.com 18.141.5.167;
    return 404; # managed by Certbot
}
